!function(r,n){var t;function a(t,e){return t.hasOwnProperty(e)}function i(t){var e=n.console;e&&e.error&&e.error(t)}r.kladr={},t="https:"==n.location.protocol?"https:":"http:",r.kladr.url=t+"//kladr-api.ru/api.php",r.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"},r.kladr.typeCode={city:1,settlement:2,village:4},r.kladr.validate=function(t){var e=r.kladr.type;switch(t.type){case e.region:case e.district:case e.city:if(t.parentType&&!t.parentId)return i("parentId undefined"),!1;break;case e.street:if(t.parentType!=e.city&&t.parentType!=e.street)return i('parentType must equal "city" or "street"'),!1;if(!t.parentId)return i("parentId undefined"),!1;break;case e.building:if(!t.zip){if(!~r.inArray(t.parentType,[e.street,e.city]))return i('parentType must equal "street" or "city"'),!1;if(!t.parentId)return i("parentId undefined"),!1}break;default:if(!t.oneString)return i("type incorrect"),!1}return t.oneString&&t.parentType&&!t.parentId?(i("parentId undefined"),!1):t.typeCode&&t.type!=e.city?(i('type must equal "city"'),!1):!(t.limit<1)||(i("limit must greater than 0"),!1)},r.kladr.api=function(t,e){if(e)if(r.kladr.validate(t)){var n=setTimeout(function(){e([]),n=null},3e3);r.ajax({url:r.kladr.url+"?callback=?",type:"get",data:function(t){var e={},n={type:"contentType",name:"query",withParents:"withParent"};t.parentType&&t.parentId&&(e[t.parentType+"Id"]=t.parentId);for(var r in t)a(t,r)&&t[r]&&(e[a(n,r)?n[r]:r]=t[r]);return e}(t),dataType:"jsonp"}).done(function(t){n&&(e(t.result||[]),clearTimeout(n))})}else e([]);else i("Callback undefined")},r.kladr.check=function(t,e){e?(t.withParents=!1,t.limit=1,r.kladr.api(t,function(t){t&&t.length?e(t[0]):e(!1)})):i("Callback undefined")}}(jQuery,window),function(I,C,j){var S={token:null,key:null,type:null,typeCode:null,parentType:null,parentId:null,limit:10,oneString:!1,withParents:!1,noResultText:null,checkEmptyRespone:!1,strict:null,parentInput:null,verify:!1,spinner:!0,open:null,close:null,send:null,receive:null,select:null,check:null,change:null,openBefore:null,closeBefore:null,sendBefore:null,selectBefore:null,checkBefore:null,source:function(t,e){I.kladr.api(t,e)},labelFormat:function(t,e){var n;if(e.oneString)return t.parents?((n=[].concat(t.parents)).push(t),I.kladr.buildAddress(n)):(t.typeShort?t.typeShort+". ":"")+t.name;var r,a,i,l,o="";return t.typeShort&&(o+=t.typeShort+". "),a=(r=t.name).toLowerCase(),i=e.name.toLowerCase(),l=~(l=a.indexOf(i))?l:0,i.length<a.length?(o+=r.substr(0,l),o+="<strong>",o+=r.substr(l,i.length),o+="</strong>",o+=r.substr(l+i.length)):o+="<strong>"+r+"</strong>",o},valueFormat:function(t,e){var n;return e.oneString?t.parents?((n=[].concat(t.parents)).push(t),I.kladr.buildAddress(n)):(t.typeShort?t.typeShort+". ":"")+t.name:t.name},showSpinner:function(t){var e=-.2,n=setInterval(function(){if(!t.is(":visible"))return clearInterval(n),void(n=null);t.css("background-position","0% "+e+"%"),95<(e+=5.555556)&&(e=-.2)},30);t.show()},hideSpinner:function(t){t.hide()}},a={current:null,controller:null},_=38,B=40,x=13;function i(t,e){var n={obj:!1,str:!1,isGet:!1};return"object"===I.type(t)?n.obj=t:"string"===I.type(t)&&(n.str=[t,e],n.isGet=void 0===e),n}function P(t,e){return t.hasOwnProperty(e)}I.kladr=I.extend(I.kladr,{setDefault:function(t,e){var n=i(t,e);if(n.obj)for(var r in n.obj)P(S,r)&&(S[r]=n.obj[r]);else n.str&&!n.isGet&&P(S,n.str[0])&&(S[n.str[0]]=n.str[1])},getDefault:function(t){if(P(S,t))return S[t]},getInputs:function(t){var e=I(t||j.body),n="[data-kladr-type]";return e.filter(n).add(e.find(n))},setValues:function(t,e){var a,n,i="kladr_change.setvalues",r=I.kladr.type,l={},o={};if(~I.inArray(I.type(t),["object","array"])){for(n in I.each(t,function(t,e){if(e){var n=e.contentType||e.type||t;P(r,n)&&(l[n]=e)}}),r)P(r,n)&&l[n]&&(o[n]=l[n]);a=I.kladr.getInputs(e),function t(){var e,n,r;for(n in o)if(P(o,n)){r=o[n],delete o[n];break}n&&((e=a.filter('[data-kladr-type="'+n+'"]')).length?e.on(i,function(){e.off(i),t()}).kladr("controller").setValue(r):t())}()}},getAddress:function(t,e){var n,r=I.kladr.getInputs(t),a=I.kladr.type,i={},l={};for(n in r.each(function(){var t,e,n,r=I(this);if(r.attr("data-kladr-id"))if(t=r.kladr("current"),r.attr("data-kladr-one-string")&&t.parents)for((e=[].concat(t.parents)).push(t),n=0;n<e.length;n++)i[e[n].contentType]=e[n];else i[r.attr("data-kladr-type")]=t;else i[r.attr("data-kladr-type")]=r.val()}),a)P(a,n)&&i[n]&&(l[n]=i[n]);return(e||I.kladr.buildAddress)(l)},buildAddress:function(t){var i=[],l="",o="";return I.each(t,function(t,e){var n,r="",a="";if("object"===I.type(e)){for(n=0;n<i.length;n++)if(i[n]==e.id)return;i.push(e.id),r=e.name,a=e.typeShort+". ",o=e.zip||o}else r=e;l&&(l+=", "),l+=a+r}),l=(o?o+", ":"")+l}}),I.fn.kladr=function(t,e){var n=i(t,e),r=null;return this.each(function(){var t=function(T,t){var n=function(){var n="kladr-data",r=T.data(n);return r||(r=I.extend({},S,a),T.data(n,r)),{set:function(t){if(t.obj)for(var e in t.obj)P(t.obj,e)&&P(S,e)&&(r[e]=t.obj[e]);else t.str&&!t.isGet&&P(S,t.str[0])&&(r[t.str[0]]=t.str[1]);T.data(n,r)},get:function(t){if(P(S,t)||P(a,t))return r[t]},_set:function(t,e){r[t]=e,T.data(n,r)},_get:function(t){if(P(r,t))return r[t]}}}();return function(t,e){if(t.isGet)return n.get(t.str[0]);n.set(t),e()}(t,function(){var d=null,l=null,a=!1,i=".kladr",o="kladrInputChange";function u(){var t=T.offset(),e=T.outerWidth(),n=T.outerHeight();if(t&&(u.top!=t.top||u.left!=t.left||u.width!=e||u.height!=n)){u.top=t.top,u.left=t.left,u.width=e,u.height=n,d.css({top:n+"px",left:0});var r=d.outerWidth()-d.width();d.width(e-r);var a=l.width(),i=l.height();l.css({top:t.top+(n-i)/2-1,left:t.left+e-a-2})}}function t(t){if(!(8<t.which&&t.which<46))if(T.data(o,!1),p("open_before")){g(null);var e=T.val();if(!I.trim(e))return m(!1),void c();var n=h(e);p("send_before",n)?(v(),p("send"),b("source")(n,function(t){return p("receive",t),T.is(":focus")?I.trim(T.val())&&t.length?(a=!0,function(t,e){var n,r,a,i;d.empty();for(var l=0;l<t.length;l++)n=t[l],r=b("valueFormat")(n,e),a=b("labelFormat")(n,e),"Бесплатная версия kladr-api.ru"!=r&&((i=I('<a data-val="'+r+'">'+a+"</a>")).data("kladr-object",n),I("<li></li>").append(i).appendTo(d))}(t,n),u(),y(),d.slideDown(50),void p("open")):(y(),g(null),function(){var t,e;d.empty(),null!=(t=S.noResultText)&&""!=t&&((e=I('<a data-val="">'+t+"</a>")).data("kladr-object",{}),I("<li></li>").append(e).appendTo(d))}(),u(),d.slideDown(50),p("open"),void(a=!1)):(y(),void c())})):c()}else c()}function c(){p("close_before")&&(d.empty().hide(),p("close"))}function s(t){var e,n,r,a,i,l,o,u=d.find("li.active");switch(t.which){case _:u.length?(u.removeClass("active"),u.prev().length&&(u=u.prev())):u=d.find("li").last(),i=d.scrollTop(),l=d.offset(),o=u.outerHeight(),u.offset().top-l.top<0&&d.scrollTop(i-o),u.addClass("active"),f();break;case B:u.length?(u.removeClass("active"),u.next().length&&(u=u.next())):u=d.find("li").first(),u.length&&(e=d.scrollTop(),n=d.height(),r=d.offset(),a=u.outerHeight(),u.offset().top-r.top+a>n&&d.scrollTop(e+a)),u.addClass("active"),f();break;case x:c()}}function f(){if(p("select_before")){var t=d.find(".active a");t.length&&(T.val(t.attr("data-val")).data(o,!0),m(!1),g(t.data("kladr-object")),p("select",b("current")))}}function p(t,e){if(!t)return!0;var n=t.replace(/_([a-z])/gi,function(t,e){return e.toUpperCase()});return T.trigger("kladr_"+t,e),"function"!==I.type(b(n))||!1!==b(n).call(T.get(0),e)}function v(){b("spinner")&&b("showSpinner")(l)}function y(){b("spinner")&&b("hideSpinner")(l)}function h(t){var e,n={},r=["token","key","type","typeCode","parentType","parentId","oneString","withParents","limit","strict"];for(e=0;e<r.length;e++)n[r[e]]=b(r[e]);n.name=k(t);var a,i=b("parentInput");return i&&(a=function(t,e){var n,r=I.kladr.getInputs(t),a=I.kladr.type,i={},l=null;for(n in r.each(function(){var t,e=I(this);(t=e.attr("data-kladr-id"))&&(i[e.attr("data-kladr-type")]=t)}),a){if(n==e)return l;P(a,n)&&i[n]&&(l={type:n,id:i[n]})}return l}(i,n.type))&&(n.parentType=a.type,n.parentId=a.id),n.oneString&&(n.withParents=!0),n}function k(t){for(var e=t.toLowerCase(),n=0;n<e.length;n++)if(~"abcdefghijklmnopqrstuvwxyz".indexOf(e[n]))return m(!0),t;return m(!1),t}function g(t){var e=b("current");(e&&e.id)!==(t&&t.id)&&(w("current",t),t&&t.id?T.attr("data-kladr-id",t.id):T.removeAttr("data-kladr-id"),b("oneString")&&t&&t.contentType&&T.attr("data-kladr-type",t.contentType),p("change",t))}function m(t){t?T.addClass("kladr-error"):T.removeClass("kladr-error")}function b(t){return n._get(t)}function w(t,e){n._set(t,e)}!function(t){var e=I(j.getElementById("kladr_autocomplete"));e.length||(T.wrap('<div class="ty-kladr-parent"></div>'),e=I('<div id="kladr_autocomplete"></div>').appendTo(T.parent()));var n=b("guid");n?(d=e.find(".autocomplete"+n),l=e.find(".spinner"+n),I(C).off(i),T.off(i),d.off(i)):(w("guid",n=function t(){return t.guid?++t.guid:t.guid=1}()),T.attr("autocomplete","off"),d=I('<ul class="autocomplete'+n+' autocomplete" style="display: none;"></ul>').appendTo(e),l=I('<div class="spinner'+n+' spinner" style="display: none;"></div>').appendTo(e),function(){var n={setValue:function(t){return"object"===I.type(t)?n.setValueByObject(t):"number"===I.type(t)?n.setValueById(t):"string"===I.type(t)?n.setValueByName(t):t?n:n.clear()},setValueByName:function(t){if(t=I.trim(t+"")){var a=h("");if(a.name=k(t),a.withParents=!1,a.limit=10,!p("send_before",a))return l(null,a),n;i(),p("send"),b("source")(a,function(t){p("receive");for(var e=a.name.toLowerCase(),n=null,r=0;r<t.length;r++)if(e==t[r].name.toLowerCase()){n=t[r];break}l(n,a)})}return n},setValueById:function(t){var e=h("");return e.parentType=e.type,e.parentId=t,e.limit=1,i(),I.kladr.api(e,function(t){t.length?l(t[0],e):l(null,e)}),n},setValueByObject:function(t){return l(t,h("")),n},clear:function(){return l(null,null),n}},r="data-kladr-autofill-lock";function i(){T.attr(r,!0)}function l(t,e){t?T.val(b("valueFormat")(t,e)):m(!0),g(t),T.removeAttr(r)}w("controller",n)}(),u(),function(){var e=0;!function t(){5<++e||function(){var t=T.val();if(t){var e=h(t),n=e.type,r=e.parentType,a=I.kladr.type,i=!0,l=b("controller").setValueByName;return n==a.street&&r!=a.city&&(i=!1),n!=a.building||~I.inArray(r,[a.street,a.city])||(i=!1),T.attr("data-kladr-autofill-lock")&&b("current")&&i&&l(t),!!b("current")}return!1}()||setTimeout(t,100)}()}());t()}(function(){var e=!1,n=!0,r="";T.attr("data-kladr-type",b("type")||"").attr("data-kladr-one-string",b("oneString")||null).on("keyup"+i,t).on("keydown"+i,s).on("blur"+i,function(){!e&&T.data(o)&&r!=T.val()&&T.change()}).on("blur.kladr change"+i,function(t){if(!e)return"change"==t.type&&(r=T.val()),n&&(n=!1,function(){if(!b("verify"))return;if(!p("check_before"))return;var t=I.trim(T.val());if(!t)return l(null,!1);if(b("current"))return m(!1);var i=h(t);if(i.withParents=!1,i.limit=10,!p("send_before",i))return l(null,!1),p("check",null);function l(t,e){m(e),g(t)}v(),p("send"),b("source")(i,function(t){if(p("receive"),I.trim(T.val())){for(var e=i.name.toLowerCase(),n=null,r=0;r<t.length;r++)if(e==t[r].name.toLowerCase()){n=t[r];break}n&&T.val(b("valueFormat")(n,i)),a(n,!n),p("check",n)}else a(null,!1);function a(t,e){y(),l(t,e)}})}()),!a&&S.checkEmptyRespone&&T.val(""),c(),!1}).on("focus"+i,function(){n=!0},t),d.on("touchstart.kladr mousedown"+i,"li, a",function(t){t.preventDefault(),e=!0,function(t){var e=I(t);e.is("a")&&(e=e.parents("li"));e.addClass("active"),f(),c()}(this),e=!1}),I(C).on("resize"+i,u)})})}(I(this),n);if(n.isGet)return r=t,!1}),n.isGet?r:this}}(jQuery,window,document),function(a){a.fn.kladrZip=function(r){return this.keydown(function(t){var e=t.charCode||t.keyCode||0,n=8==e||9==e||13==e||46==e||110==e||190==e||35<=e&&e<=40||96<=e&&e<=105;return 6<=a(this).val().length?n:n||48<=e&&e<=57}),this.keyup(function(){var e=a(this),t=e.val();function n(t){t?e.addClass("kladr-error"):e.removeClass("kladr-error")}t?a.kladr.api({type:a.kladr.type.building,zip:t,withParents:!0,limit:1},function(t){var e=t.length&&t[0];t=[],e?(n(!1),e.parents&&(t=t.concat(e.parents)),t.push(e),a.kladr.setValues(t,r)):n(!0)}):n(!1)}),this}}(jQuery);